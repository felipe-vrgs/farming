name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Repo sanity checks
        run: make sanity

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dev tooling
        run: pip install -r requirements-dev.txt

      - name: GDScript lint
        run: make lint

      - name: GDScript format check
        run: make format-check

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache Godot 4.5.1 (Linux)
        uses: actions/cache@v4
        with:
          path: .godot-bin
          key: godot-4.5.1-linux-x86_64

      - name: Download Godot 4.5.1 (Linux)
        run: |
          set -euxo pipefail
          mkdir -p .godot-bin
          cd .godot-bin
          if [ ! -f "Godot_v4.5.1-stable_linux.x86_64" ]; then
            curl -L -o godot.zip "https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_linux.x86_64.zip"
            unzip -q godot.zip
          fi
          chmod +x Godot_v4.5.1-stable_linux.x86_64
          ./Godot_v4.5.1-stable_linux.x86_64 --version

      - name: Headless tests (unit suites)
        env:
          FARMING_TEST_TIMEOUT_S: "90"
        run: |
          set -euxo pipefail
          make test GODOT_BIN="./.godot-bin/Godot_v4.5.1-stable_linux.x86_64"

      - name: Headless tests (with runtime smoke)
        # Heavier/noisier; only run on main branch pushes.
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          FARMING_TEST_TIMEOUT_S: "180"
        run: |
          set -euxo pipefail
          make test-full GODOT_BIN="./.godot-bin/Godot_v4.5.1-stable_linux.x86_64"
